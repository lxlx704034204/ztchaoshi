package com.iteambuysale.zhongtuan.background;

import java.lang.reflect.Field;

import android.content.Context;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteOpenHelper;

import com.iteambuysale.zhongtuan.ZhongTuanApp;
import com.iteambuysale.zhongtuan.annotation.Column;
import com.iteambuysale.zhongtuan.annotation.Table;
import com.iteambuysale.zhongtuan.define.D;
import com.iteambuysale.zhongtuan.model.Activities;
import com.iteambuysale.zhongtuan.model.Collection;
import com.iteambuysale.zhongtuan.model.Evaluation;
import com.iteambuysale.zhongtuan.model.OrderDetailsTG;
import com.iteambuysale.zhongtuan.model.OrderDetailsTM;
import com.iteambuysale.zhongtuan.model.OrderTG;
import com.iteambuysale.zhongtuan.model.OrderTM;
import com.iteambuysale.zhongtuan.model.Product;
import com.iteambuysale.zhongtuan.model.ProductCategory;
import com.iteambuysale.zhongtuan.model.ShopMsg;
import com.iteambuysale.zhongtuan.model.SpecialSaleCatagory;
import com.iteambuysale.zhongtuan.model.Spl_sale_v2_adv;
import com.iteambuysale.zhongtuan.model.Store;
import com.iteambuysale.zhongtuan.model.TeMaiEvaluation;
import com.iteambuysale.zhongtuan.model.TemaiVerson2;
import com.iteambuysale.zhongtuan.model.Tuanbohui;
import com.iteambuysale.zhongtuan.model.User;
import com.iteambuysale.zhongtuan.model.UserAddress;
import com.iteambuysale.zhongtuan.model.ZTQ;
import com.iteambuysale.zhongtuan.utilities.LogUtilities;

public class DBHelper extends SQLiteOpenHelper {

	ZhongTuanApp instances = ZhongTuanApp.getInstance();
	Class<?>[] clazzs;
	Context context;
	public DBHelper(Context context, int version) {
		super(context, D.DB_NAME, null, version);
		this.context = context;
		clazzs = new Class<?>[] { User.class, OrderTG.class, OrderTM.class,
				OrderDetailsTG.class, OrderDetailsTM.class, Product.class,
				UserAddress.class, Store.class, Activities.class,
				Tuanbohui.class, ZTQ.class, ProductCategory.class,
				Evaluation.class, TemaiVerson2.class,
				SpecialSaleCatagory.class, Collection.class, ShopMsg.class,TeMaiEvaluation.class,Spl_sale_v2_adv.class };

	}

	@Override
	public void onCreate(final SQLiteDatabase db) {
		createTables(clazzs, db);

	}

	@Override
	public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
		dropTables(clazzs, db);
		onCreate(db);
		instances.logout(null,false);
	}

	@Override
	public void onDowngrade(SQLiteDatabase db, int oldVersion, int newVersion) {
		onUpgrade(db, oldVersion, newVersion);
	}

	/*
	 * =================================== Helpers
	 * ==========================================
	 */

	/**
	 * 删除表
	 * 
	 * @param clazz
	 * @param db
	 */
	private void dropTables(Class<?>[] clazzs, SQLiteDatabase db) {
		db.beginTransaction();
		for (Class<?> clazz : clazzs) {
			StringBuilder _strBuilder = new StringBuilder(
					"DROP TABLE IF EXISTS ");
			if (null != (clazz.getAnnotation(Table.class))) {

				_strBuilder.append(clazz.getAnnotation(Table.class).name());
				LogUtilities
						.Log(D.DB_DEBUG,
								"[Excute SQL]:" + _strBuilder.toString(),
								D.DEBUG_DEBUG);
				db.execSQL(_strBuilder.toString());
			}
		}
		db.setTransactionSuccessful();
		db.endTransaction();
	}

	/**
	 * 根据类构建数据库建表
	 * 
	 * @param clazz
	 * @param db
	 */
	private void createTables(Class<?>[] clazzs, SQLiteDatabase db) {
		db.beginTransaction();
		for (Class<?> clazz : clazzs) {
			StringBuilder _strBuilder = new StringBuilder("CREATE TABLE ");
			_strBuilder.append(clazz.getAnnotation(Table.class).name());
			_strBuilder.append("(");
			Field[] fields = clazz.getDeclaredFields();
			for (int i = 0; i < fields.length; i++) {
				Field f = fields[i];
				if (!f.isAnnotationPresent(Column.class))
					continue;
				_strBuilder.append(f.getAnnotation(Column.class).name());
				_strBuilder.append(" ");

				if (f.getAnnotation(Column.class).primary()) {
					_strBuilder.append("INTEGER PRIMARY KEY AUTOINCREMENT");
				} else {
					_strBuilder.append(f.getAnnotation(Column.class).type());
					_strBuilder.append("(");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
					_strBuilder.append(f.getAnnotation(Column.class).len());
					_strBuilder.append(")");
				}
				_strBuilder.append(",");
			}
			_strBuilder.deleteCharAt(_strBuilder.length() - 1); // 最后一个，删除“，”
			_strBuilder.append(")");
			LogUtilities.Log(D.DB_DEBUG,
					"[Excute SQL]:" + _strBuilder.toString(), D.DEBUG_DEBUG);
			db.execSQL(_strBuilder.toString());
		}
		db.setTransactionSuccessful();
		db.endTransaction();
	}

}
